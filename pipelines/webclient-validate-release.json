{"source":2,"revision":18,"description":null,"createdBy":{"displayName":"Administrator","url":"http://devops1/DefaultCollection/_apis/Identities/04ce8135-08eb-4e9a-b8af-e978deba63f0","_links":{"avatar":{"href":"http://devops1/DefaultCollection/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw"}},"id":"04ce8135-08eb-4e9a-b8af-e978deba63f0","uniqueName":"DEVOPS1\\Administrator","imageUrl":"http://devops1/DefaultCollection/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw","descriptor":"win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw"},"createdOn":"2021-03-21T10:48:16.290Z","modifiedBy":{"displayName":"Administrator","url":"http://devops1/DefaultCollection/_apis/Identities/04ce8135-08eb-4e9a-b8af-e978deba63f0","_links":{"avatar":{"href":"http://devops1/DefaultCollection/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw"}},"id":"04ce8135-08eb-4e9a-b8af-e978deba63f0","uniqueName":"DEVOPS1\\Administrator","imageUrl":"http://devops1/DefaultCollection/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw","descriptor":"win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw"},"modifiedOn":"2021-03-22T03:05:26.420Z","isDeleted":false,"lastRelease":{"id":7,"name":"Release-7","artifacts":[],"_links":{},"description":"Triggered by web-clientreport 20210321.7.","releaseDefinition":{"id":1,"projectReference":null,"_links":{}},"createdOn":"2021-03-21T11:59:39.060Z","createdBy":{"displayName":"Administrator","url":"http://devops1/DefaultCollection/_apis/Identities/04ce8135-08eb-4e9a-b8af-e978deba63f0","_links":{"avatar":{"href":"http://devops1/DefaultCollection/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw"}},"id":"04ce8135-08eb-4e9a-b8af-e978deba63f0","uniqueName":"DEVOPS1\\Administrator","imageUrl":"http://devops1/DefaultCollection/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw","descriptor":"win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw"}},"variables":{"container-project":{"value":"lloyd-266015"},"container-repository-release":{"value":"asia.gcr.io/lloyd-266015"},"container-repository-test":{"value":"us.gcr.io/lloyd-266015"}},"variableGroups":[2],"environments":[{"id":1,"name":"Deploy Build for Test","rank":1,"owner":{"displayName":"Administrator","url":"http://devops1/DefaultCollection/_apis/Identities/04ce8135-08eb-4e9a-b8af-e978deba63f0","_links":{"avatar":{"href":"http://devops1/DefaultCollection/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw"}},"id":"04ce8135-08eb-4e9a-b8af-e978deba63f0","uniqueName":"DEVOPS1\\Administrator","imageUrl":"http://devops1/DefaultCollection/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw","descriptor":"win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":1}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":2},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":3}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":6,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"cbc316a2-586f-4def-be79-488a1f503564","version":"0.*","name":"Create target Namespace","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":null,"overrideInputs":{},"condition":"succeeded()","inputs":{"kubernetesServiceEndpoint":"237ffb67-1c76-4037-9feb-e024d590767a","namespace":"","command":"create","useConfigurationFile":"false","configuration":"","arguments":"ns $(build.DefinitionName)-$(Build.BuildId)","secretType":"dockerRegistry","secretArguments":"","containerRegistryType":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpoint":"","azureContainerRegistry":"","secretName":"","forceUpdate":"true","configMapName":"","forceUpdateConfigMap":"false","useConfigMapFile":"false","configMapFile":"","configMapArguments":"","versionOrLocation":"version","versionSpec":"1.7.0","checkLatest":"false","specifyLocation":"","cwd":"$(System.DefaultWorkingDirectory)","outputFormat":"json","kubectlOutput":""}},{"environment":{},"taskId":"cbc316a2-586f-4def-be79-488a1f503564","version":"1.*","name":"Deploy Workload","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Kubernetes Service Connection","kubernetesServiceEndpoint":"237ffb67-1c76-4037-9feb-e024d590767a","azureSubscriptionEndpoint":"","azureResourceGroup":"","kubernetesCluster":"","useClusterAdmin":"false","namespace":"$(build.DefinitionName)-$(Build.BuildId)","command":"apply","useConfigurationFile":"true","configurationType":"inline","configuration":"","inline":"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: $(build.DefinitionName)\n  labels:\n    app: webreporter\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: webreporter\n  template:\n    metadata:\n      labels:\n        app: webreporter\n    spec:\n      containers:\n      - name: webreporter\n        image: '$(container-repository-test)/$(build.DefinitionName):$(Build.BuildId)'\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 80\n","arguments":"","secretType":"dockerRegistry","secretArguments":"","containerRegistryType":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpointForSecrets":"","azureContainerRegistry":"","secretName":"","forceUpdate":"true","configMapName":"","forceUpdateConfigMap":"false","useConfigMapFile":"false","configMapFile":"","configMapArguments":"","versionOrLocation":"version","versionSpec":"1.13.2","checkLatest":"false","specifyLocation":"","cwd":"$(System.DefaultWorkingDirectory)","outputFormat":"json"}},{"environment":{},"taskId":"cbc316a2-586f-4def-be79-488a1f503564","version":"1.*","name":"Create Service","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Kubernetes Service Connection","kubernetesServiceEndpoint":"237ffb67-1c76-4037-9feb-e024d590767a","azureSubscriptionEndpoint":"","azureResourceGroup":"","kubernetesCluster":"","useClusterAdmin":"false","namespace":"$(build.DefinitionName)-$(Build.BuildId)","command":"apply","useConfigurationFile":"true","configurationType":"inline","configuration":"","inline":"apiVersion: v1\nkind: Service\nmetadata:\n  name: $(build.DefinitionName)\n  labels:\n    app: webreporter-svc\nspec:\n  ports:\n    # the port that this service should serve on\n    - port: 80\n  selector:\n    app: webreporter\n  sessionAffinity: ClientIP\n  type: LoadBalancer\n\n","arguments":"","secretType":"dockerRegistry","secretArguments":"","containerRegistryType":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpointForSecrets":"","azureContainerRegistry":"","secretName":"","forceUpdate":"true","configMapName":"","forceUpdateConfigMap":"false","useConfigMapFile":"false","configMapFile":"","configMapArguments":"","versionOrLocation":"version","versionSpec":"1.13.2","checkLatest":"false","specifyLocation":"","cwd":"$(System.DefaultWorkingDirectory)","outputFormat":"json"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"ReleaseStarted","conditionType":1,"value":""}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":7,"url":"http://devops1/DefaultCollection/b9499b6b-ae4b-4553-bb4c-640a8468c455/_apis/Release/releases/7","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"http://devops1/DefaultCollection/_apis/public/Release/badge/b9499b6b-ae4b-4553-bb4c-640a8468c455/1/1"},{"id":3,"name":"Validate and Cleanup Test Deploy","rank":2,"owner":{"displayName":"Administrator","url":"http://devops1/DefaultCollection/_apis/Identities/04ce8135-08eb-4e9a-b8af-e978deba63f0","_links":{"avatar":{"href":"http://devops1/DefaultCollection/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw"}},"id":"04ce8135-08eb-4e9a-b8af-e978deba63f0","uniqueName":"DEVOPS1\\Administrator","imageUrl":"http://devops1/DefaultCollection/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw","descriptor":"win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":7}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":8},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":9}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":2,"name":"Agentless job","refName":null,"workflowTasks":[{"environment":{},"taskId":"bcb64569-d51a-4af0-9c01-ea5d05b3b622","version":"8.*","name":"Validate Build State","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"instructions":"Deployment has now been deployed to Namespace '$(build.DefinitionName)-$(Build.BuildId)'. \n\nIs build acceptable for promotion?","emailRecipients":"","onTimeout":"reject"}}]},{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":6,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":2,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"cbc316a2-586f-4def-be79-488a1f503564","version":"0.*","name":"Delete Service","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":null,"overrideInputs":{},"condition":"succeeded()","inputs":{"kubernetesServiceEndpoint":"237ffb67-1c76-4037-9feb-e024d590767a","namespace":"$(build.DefinitionName)-$(Build.BuildId)","command":"delete","useConfigurationFile":"false","configuration":"","arguments":"service $(build.DefinitionName)","secretType":"dockerRegistry","secretArguments":"","containerRegistryType":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpoint":"","azureContainerRegistry":"","secretName":"","forceUpdate":"true","configMapName":"","forceUpdateConfigMap":"false","useConfigMapFile":"false","configMapFile":"","configMapArguments":"","versionOrLocation":"version","versionSpec":"1.7.0","checkLatest":"false","specifyLocation":"","cwd":"$(System.DefaultWorkingDirectory)","outputFormat":"json","kubectlOutput":""}},{"environment":{},"taskId":"cbc316a2-586f-4def-be79-488a1f503564","version":"1.*","name":"Delete Deployment","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Kubernetes Service Connection","kubernetesServiceEndpoint":"237ffb67-1c76-4037-9feb-e024d590767a","azureSubscriptionEndpoint":"","azureResourceGroup":"","kubernetesCluster":"","useClusterAdmin":"false","namespace":"$(build.DefinitionName)-$(Build.BuildId)","command":"delete","useConfigurationFile":"false","configurationType":"configuration","configuration":"","inline":"","arguments":"deploy $(build.DefinitionName)","secretType":"dockerRegistry","secretArguments":"","containerRegistryType":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpointForSecrets":"","azureContainerRegistry":"","secretName":"","forceUpdate":"true","configMapName":"","forceUpdateConfigMap":"false","useConfigMapFile":"false","configMapFile":"","configMapArguments":"","versionOrLocation":"version","versionSpec":"1.13.2","checkLatest":"false","specifyLocation":"","cwd":"$(System.DefaultWorkingDirectory)","outputFormat":"json"}},{"environment":{},"taskId":"cbc316a2-586f-4def-be79-488a1f503564","version":"1.*","name":"Delete Namespace","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Kubernetes Service Connection","kubernetesServiceEndpoint":"237ffb67-1c76-4037-9feb-e024d590767a","azureSubscriptionEndpoint":"","azureResourceGroup":"","kubernetesCluster":"","useClusterAdmin":"false","namespace":"","command":"delete","useConfigurationFile":"false","configurationType":"configuration","configuration":"","inline":"","arguments":"ns $(build.DefinitionName)-$(Build.BuildId)","secretType":"dockerRegistry","secretArguments":"","containerRegistryType":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpointForSecrets":"","azureContainerRegistry":"","secretName":"","forceUpdate":"true","configMapName":"","forceUpdateConfigMap":"false","useConfigMapFile":"false","configMapFile":"","configMapArguments":"","versionOrLocation":"version","versionSpec":"1.13.2","checkLatest":"false","specifyLocation":"","cwd":"$(System.DefaultWorkingDirectory)","outputFormat":"json"}},{"environment":{},"taskId":"e28912f1-0114-4464-802a-a3a35437fd16","version":"2.*","name":"Tag Image for Release","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"containerRegistry":"7edcb9c0-3f37-454b-8ddd-ff5b8bcfa8b5","repository":"","command":"tag","Dockerfile":"**/Dockerfile","buildContext":"**","tags":"$(Build.BuildId)","arguments":"$(container-repository-test)/$(build.DefinitionName):$(Build.BuildId) $(container-repository-release)/$(build.DefinitionName):$(Build.BuildId)","addPipelineData":"true"}},{"environment":{},"taskId":"e28912f1-0114-4464-802a-a3a35437fd16","version":"2.*","name":"Push Image for Release","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"containerRegistry":"7edcb9c0-3f37-454b-8ddd-ff5b8bcfa8b5","repository":"$(container-project)/$(build.DefinitionName)","command":"push","Dockerfile":"**/Dockerfile","buildContext":"**","tags":"$(Build.BuildId)","arguments":"","addPipelineData":"true"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"Deploy Build for Test","conditionType":2,"value":"4"}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":7,"url":"http://devops1/DefaultCollection/b9499b6b-ae4b-4553-bb4c-640a8468c455/_apis/Release/releases/7","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"http://devops1/DefaultCollection/_apis/public/Release/badge/b9499b6b-ae4b-4553-bb4c-640a8468c455/1/3"},{"id":4,"name":"Release to Production","rank":3,"owner":{"displayName":"Administrator","url":"http://devops1/DefaultCollection/_apis/Identities/04ce8135-08eb-4e9a-b8af-e978deba63f0","_links":{"avatar":{"href":"http://devops1/DefaultCollection/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw"}},"id":"04ce8135-08eb-4e9a-b8af-e978deba63f0","uniqueName":"DEVOPS1\\Administrator","imageUrl":"http://devops1/DefaultCollection/_apis/GraphProfile/MemberAvatars/win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw","descriptor":"win.Uy0xLTUtMjEtNDIwMzc0NDY1NS0yOTYyMTQ1OTM1LTM4MDUxNDkwNjctNTAw"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":10}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":11},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":12}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":null,"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":6,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Agent job","refName":null,"workflowTasks":[{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Create Supervisor Namespace","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"#!/bin/bash\n\n# Script to onboard a new namespace in a supervisor cluster\n\n#Variables required \n#VCENTER_NAME\n#VCENTER_ACCOUNT\n#VCENTER_PASSWORD\n\n#SERVICE_CLUSTER\n#SERVICE_OWNER_NAME\n#SERVICE_OWNER_DOMAIN\n\n#SERVICE_STORAGE_POLICY\n#SERVICE_MEM_LIMIT\n#SERVICE_CPU_LIMIT\n\nNAMESPACE=$(build.DefinitionName)-$(Build.BuildId)\n\n#login\necho \"Login to $VCENTER_NAME with $VCENTER_ACCOUNT\"\nAUTH=$(echo -n \"$VCENTER_ACCOUNT:$VCENTER_PASSWORD\" | base64)\nSESSIONID=$(curl -k -s -X  POST \"https://$VCENTER_NAME/rest/com/vmware/cis/session\" -H 'Content-type: application/json' -H \"Authorization: Basic $AUTH\" -H 'Accept: application/json' -H 'vmware-use-header-authn: test' -H 'vmware-api-session-id: null' | jq '.value')\nSESSIONID=`echo $SESSIONID | sed 's/.\\(.*\\)/\\1/' | sed 's/\\(.*\\)./\\1/'`\necho \"Session ID: $SESSIONID\"\n\n#get storage policy id\nPOLICYID=$(curl -k -s -X GET \"https://$VCENTER_NAME/rest/vcenter/storage/policies\" -H 'Content-type: application/json' -H \"vmware-api-session-id: $SESSIONID\" | jq --arg sp \"$SERVICE_STORAGE_POLICY\" '.value[] | select(.name == $sp) | .policy')\nPOLICYID=`echo $POLICYID | sed 's/.\\(.*\\)/\\1/' | sed 's/\\(.*\\)./\\1/'`\necho \"StoragePolicy ID: $POLICYID\"\n\n#get cluster id\nCLUSTERID=$(curl -k -s -X GET \"https://$VCENTER_NAME/api/vcenter/namespace-management/clusters\" -H 'Content-type: application/json' -H \"vmware-api-session-id: $SESSIONID\"  | jq '.[0].cluster')\nCLUSTERID=`echo $CLUSTERID | sed 's/.\\(.*\\)/\\1/' | sed 's/\\(.*\\)./\\1/'`\necho \"Cluster ID: $POLICYID\"\n\n# Define permissions \nACCESSLIST=\"[{\\\"role\\\": \\\"EDIT\\\",\\\"subject_type\\\": \\\"USER\\\",\\\"subject\\\": \\\"$SERVICE_OWNER_NAME\\\",\\\"domain\\\": \\\"$SERVICE_OWNER_DOMAIN\\\"}]\"\n\n# Set Quotas\nRESOURCESPEC=\"{\\\"cpu_limit\\\": $SERVICE_CPU_LIMIT,\\\"memory_limit\\\": $SERVICE_MEM_LIMIT}\"\n\n# Definte Storage Access\nSTORAGESPEC=\"[{\\\"policy\\\": \\\"$POLICYID\\\"}]\"\n\n# Create payload\nNSDATA=\"{\\\"namespace\\\": \\\"$NAMESPACE\\\", \\\"cluster\\\": \\\"$CLUSTERID\\\", \\\"access_list\\\": $ACCESSLIST, \\\"storage_specs\\\": $STORAGESPEC, \\\"resource_spec\\\": $RESOURCESPEC }\"\n\n# Create namespace\ncurl -k -s -X POST -H \"Content-Type: application/json\"  -H \"vmware-api-session-id: $SESSIONID\" -d \"$NSDATA\" \"https://$VCENTER_NAME/api/vcenter/namespaces/instances\"\n\n# Wait for Namespace to initialise\nsleep 15\n\n","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"}},{"environment":{},"taskId":"cbc316a2-586f-4def-be79-488a1f503564","version":"1.*","name":"Deploy Release","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Kubernetes Service Connection","kubernetesServiceEndpoint":"1d2ed5f9-e373-472d-963c-e3289ef3a9b7","azureSubscriptionEndpoint":"","azureResourceGroup":"","kubernetesCluster":"","useClusterAdmin":"false","namespace":"$(build.DefinitionName)-$(Build.BuildId)","command":"apply","useConfigurationFile":"true","configurationType":"inline","configuration":"","inline":"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: $(build.DefinitionName)\n  labels:\n    app: webreporter\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: webreporter\n  template:\n    metadata:\n      labels:\n        app: webreporter\n    spec:\n      containers:\n      - name: webreporter\n        image: '$(container-repository-release)/$(build.DefinitionName):$(Build.BuildId)'\n        imagePullPolicy: Always\n        ports:\n        - containerPort: 80\n","arguments":"","secretType":"dockerRegistry","secretArguments":"","containerRegistryType":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpointForSecrets":"","azureContainerRegistry":"","secretName":"","forceUpdate":"true","configMapName":"","forceUpdateConfigMap":"false","useConfigMapFile":"false","configMapFile":"","configMapArguments":"","versionOrLocation":"version","versionSpec":"1.13.2","checkLatest":"false","specifyLocation":"","cwd":"$(System.DefaultWorkingDirectory)","outputFormat":"json"}},{"environment":{},"taskId":"cbc316a2-586f-4def-be79-488a1f503564","version":"1.*","name":"Create Service","refName":"service","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Kubernetes Service Connection","kubernetesServiceEndpoint":"1d2ed5f9-e373-472d-963c-e3289ef3a9b7","azureSubscriptionEndpoint":"","azureResourceGroup":"","kubernetesCluster":"","useClusterAdmin":"false","namespace":"$(build.DefinitionName)-$(Build.BuildId)","command":"apply","useConfigurationFile":"true","configurationType":"inline","configuration":"","inline":"apiVersion: v1\nkind: Service\nmetadata:\n  name: $(build.DefinitionName)\n  labels:\n    app: webreporter-svc\nspec:\n  ports:\n    # the port that this service should serve on\n    - port: 80\n  selector:\n    app: webreporter\n  sessionAffinity: ClientIP\n  type: LoadBalancer\n\n","arguments":"","secretType":"dockerRegistry","secretArguments":"","containerRegistryType":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpointForSecrets":"","azureContainerRegistry":"","secretName":"","forceUpdate":"true","configMapName":"","forceUpdateConfigMap":"false","useConfigMapFile":"false","configMapFile":"","configMapArguments":"","versionOrLocation":"version","versionSpec":"1.13.2","checkLatest":"false","specifyLocation":"","cwd":"$(System.DefaultWorkingDirectory)","outputFormat":"json"}},{"environment":{},"taskId":"cbc316a2-586f-4def-be79-488a1f503564","version":"1.*","name":"Create Ingress","refName":"ingress","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectionType":"Kubernetes Service Connection","kubernetesServiceEndpoint":"1d2ed5f9-e373-472d-963c-e3289ef3a9b7","azureSubscriptionEndpoint":"","azureResourceGroup":"","kubernetesCluster":"","useClusterAdmin":"false","namespace":"$(build.DefinitionName)-$(Build.BuildId)","command":"apply","useConfigurationFile":"true","configurationType":"inline","configuration":"","inline":"apiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  name: webreport-frontend\n  annotations:\n    kubernetes.io/ingress.class: \"nsx\"\nspec:\n  rules:\n  - host: webreport.home.local\n    http:\n      paths:\n      - backend:\n          serviceName: webreporter-svc\n          servicePort: 80\n         ","arguments":"","secretType":"dockerRegistry","secretArguments":"","containerRegistryType":"Azure Container Registry","dockerRegistryEndpoint":"","azureSubscriptionEndpointForSecrets":"","azureContainerRegistry":"","secretName":"","forceUpdate":"true","configMapName":"","forceUpdateConfigMap":"false","useConfigMapFile":"false","configMapFile":"","configMapArguments":"","versionOrLocation":"version","versionSpec":"1.13.2","checkLatest":"false","specifyLocation":"","cwd":"$(System.DefaultWorkingDirectory)","outputFormat":"json"}},{"environment":{},"taskId":"6c731c3c-3c68-459a-a5c9-bde6e6595b5b","version":"3.*","name":"Create DNS Entry","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"targetType":"inline","filePath":"","arguments":"","script":"# Write your commands here\n\necho '$ingress.KubectlOutput'\t\n'\n","workingDirectory":"","failOnStderr":"false","noProfile":"true","noRc":"true"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"Validate and Cleanup Test Deploy","conditionType":2,"value":"4"}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":0,"url":"http://devops1/DefaultCollection/b9499b6b-ae4b-4553-bb4c-640a8468c455/_apis/Release/releases/0","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{"BoardsEnvironmentType":{"$type":"System.String","$value":"unmapped"},"LinkBoardsWorkItems":{"$type":"System.String","$value":"False"}},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"http://devops1/DefaultCollection/_apis/public/Release/badge/b9499b6b-ae4b-4553-bb4c-640a8468c455/1/4"}],"artifacts":[{"sourceId":"b9499b6b-ae4b-4553-bb4c-640a8468c455:2","type":"Build","alias":"_web-clientreport","definitionReference":{"artifactSourceDefinitionUrl":{"id":"http://devops1/_permalink/_build/index?collectionId=120a3a69-3f30-43cb-8293-f5bed18941df&projectId=b9499b6b-ae4b-4553-bb4c-640a8468c455&definitionId=2","name":""},"defaultVersionBranch":{"id":"","name":""},"defaultVersionSpecific":{"id":"","name":""},"defaultVersionTags":{"id":"","name":""},"defaultVersionType":{"id":"latestType","name":"Latest"},"definition":{"id":"2","name":"web-clientreport"},"definitions":{"id":"","name":""},"IsMultiDefinitionType":{"id":"False","name":"False"},"project":{"id":"b9499b6b-ae4b-4553-bb4c-640a8468c455","name":"web-clientreport"},"repository":{"id":"","name":""}},"isPrimary":true,"isRetained":false}],"triggers":[{"artifactAlias":"_web-clientreport","triggerConditions":[],"triggerType":1}],"releaseNameFormat":"Release-$(rev:r)","tags":[],"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"ReleaseNew"},"IntegrateBoardsWorkItems":{"$type":"System.String","$value":"False"},"System.EnvironmentRankLogicVersion":{"$type":"System.String","$value":"2"}},"id":1,"name":"webclient-validate-release","path":"\\","projectReference":null,"url":"http://devops1/DefaultCollection/b9499b6b-ae4b-4553-bb4c-640a8468c455/_apis/Release/definitions/1","_links":{"self":{"href":"http://devops1/DefaultCollection/b9499b6b-ae4b-4553-bb4c-640a8468c455/_apis/Release/definitions/1"},"web":{"href":"http://devops1/DefaultCollection/b9499b6b-ae4b-4553-bb4c-640a8468c455/_release?definitionId=1"}}}